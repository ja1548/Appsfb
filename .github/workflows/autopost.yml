name: AutoPost Facebook Page

on:
  schedule:
    - cron: "0 * * * *"  # Setiap 1 jam
  workflow_dispatch:  # Bisa dijalankan manual juga

jobs:
  autopost:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Generate caption otomatis pakai OpenAI
      id: caption
      run: |
        echo "Membuat caption otomatis..."
        CAPTION=$(curl https://api.openai.com/v1/chat/completions \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
          -d '{
            "model": "gpt-4o-mini",
            "messages": [
              {"role": "system", "content": "Kamu adalah penulis caption sosial media yang singkat dan menarik."},
              {"role": "user", "content": "Buatkan caption promosi produk affiliate secara random dan menarik dalam 1 kalimat."}
            ],
            "max_tokens": 60
          }' | jq -r '.choices[0].message.content')
        echo "CAPTION=$CAPTION" >> $GITHUB_ENV
        echo "Caption: $CAPTION"

    - name: Post to Facebook Page
      run: |
        echo "Posting ke Facebook Page..."
        RESPONSE=$(curl -X POST "https://graph.facebook.com/v19.0/${{ secrets.FB_PAGE_ID }}/feed" \
          -F "message=${{ env.CAPTION }}" \
          -F "access_token=${{ secrets.FB_PAGE_TOKEN }}")
        echo "Response: $RESPONSE"

    - name: Simpan log
      run: |
        echo "Log: $(date)" > logs.txt
        echo "${{ env.CAPTION }}" >> logs.txt
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git add logs.txt
        git commit -m "Update logs $(date)" || echo "Tidak ada perubahan"
        git push || echo "Gagal push (abaikan kalau readonly)"
