name: AI Auto Caption & Facebook Post (Every Hour)

on:
  schedule:
    - cron: "0 * * * *"  # tiap 1 jam
  workflow_dispatch:

jobs:
  autopost:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Generate AI caption & post to Facebook
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          FB_TOKEN: ${{ secrets.FB_LONG_LIVED_TOKEN }}
        run: |
          echo "ðŸš€ Mulai generate caption otomatis..."

          # Tentukan tema acak
          THEMES=(
            "kata motivasi bijak"
            "sindiran mantan kekasih"
            "sindiran orang tidak tahu terima kasih"
            "sindiran orang tidak bayar hutang"
            "kata bijak bekerja keras"
            "kata lucu belanja online"
            "kata bijak hidup sukses"
          )
          RANDOM_INDEX=$((RANDOM % ${#THEMES[@]}))
          THEME=${THEMES[$RANDOM_INDEX]}

          echo "ðŸŽ¯ Tema terpilih: $THEME"

          # Generate caption pakai OpenAI API
          CAPTION=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"gpt-3.5-turbo\",
              \"messages\": [
                {\"role\": \"system\", \"content\": \"Buat satu kalimat singkat berbahasa Indonesia sesuai tema berikut. Harus cocok untuk posting Facebook, mengandung emosi dan kesan, maksimal 25 kata.\"},
                {\"role\": \"user\", \"content\": \"$THEME\"}
              ],
              \"max_tokens\": 60
            }" | jq -r '.choices[0].message.content')

          echo "ðŸ“ Caption dibuat: $CAPTION"

          # Tambahkan link Shopee affiliate
          MESSAGE="$CAPTION ðŸ›ï¸ Cek promo Shopee ðŸ‘‰ https://id.shp.ee/e2eqze5"

          # Buat logs.txt kalau belum ada
          if [ ! -f logs.txt ]; then
            echo "ðŸ“„ Membuat logs.txt baru..."
            touch logs.txt
          fi

          # Posting ke Facebook
          RESPONSE=$(curl -s -X POST "https://graph.facebook.com/v19.0/me/feed" \
            -F "message=$MESSAGE" \
            -F "access_token=${FB_TOKEN}")

          echo "ðŸ“¢ Hasil posting: $RESPONSE"

          # Simpan caption ke logs
          echo "$CAPTION" >> logs.txt
          echo "---" >> logs.txt
          echo "$(date)" >> logs.txt
          echo "" >> logs.txt

          # Commit hasil log ke repo
          git config --global user.name "AutoPoster"
          git config --global user.email "actions@github.com"
          git add logs.txt
          git commit -m "Update logs $(date)"
          git push
