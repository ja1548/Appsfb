name: AI Auto Caption & Post to Facebook

on:
  schedule:
    - cron: "0 */3 * * *"   # jalan tiap 3 jam
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest

    steps:
      - name: Generate caption & post to Facebook
        env:
          FB_TOKEN: ${{ secrets.FB_LONG_LIVED_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Tentukan tema acak
          THEMES=(
            "kata motivasi bijak"
            "sindiran mantan kekasih"
            "sindiran orang tidak tahu terima kasih"
            "sindiran orang tidak bayar hutang"
            "kata bijak bekerja keras"
            "kata lucu belanja online"
            "kata bijak hidup sukses"
          )
          RANDOM_INDEX=$((RANDOM % ${#THEMES[@]}))
          THEME=${THEMES[$RANDOM_INDEX]}

          echo "Tema terpilih: $THEME"

          # Gunakan AI (OpenAI API) untuk buat caption
          CAPTION=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"gpt-3.5-turbo\",
              \"messages\": [
                {\"role\": \"system\", \"content\": \"Buat satu kalimat singkat berbahasa Indonesia sesuai tema berikut, cocok untuk posting Facebook, menarik, dan berkesan.\"},
                {\"role\": \"user\", \"content\": \"$THEME\"}
              ],
              \"max_tokens\": 50
            }" | jq -r '.choices[0].message.content')

          # Tambahkan link affiliate Kang
          MESSAGE="$CAPTION

üõçÔ∏è Cek promo Shopee Affiliate üëâ https://id.shp.ee/e2eqze5?smtt=0.0.9"

          # Kirim ke Facebook
          curl -X POST "https://graph.facebook.com/v19.0/me/feed" \
          -F "message=$MESSAGE" \
          -F "access_token=${FB_TOKEN}"
